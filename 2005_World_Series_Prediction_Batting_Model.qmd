---
title: "2005_World_Series_Prediction_Batting_Model"
format: html
editor: visual
---

## 2005 World Series Prediction Batting stats only

Machine Learning Training model with 2000 to 2004 stats from both teams.

Modern-era baseball

Post-2000 seasons represent: similar offensive environments, similar bullpen usage, pitch counts and rotations closer to current strategy #Statcast era effects start \~2015 but post 2000 is still fairly stable

```{r}
###############################################
# 1) Load packages
###############################################

library(xgboost)
library(dplyr)
library(ggplot2)
library(Lahman)
library(tidyr)
library(pROC)

###############################################
# 2) Build TEAM-LEVEL dataset (2000–2005)
###############################################

teams <- Teams %>%
  filter(yearID >= 2000, yearID <= 2004) %>%   #restrict data window for more modern style play
  transmute(
    yearID,
    teamID,
    R,
    RA,
    WPct = W / (W + L)
  )

###############################################
# 3) Build matchup dataset (2000–2004 only)
###############################################

final_df <- teams %>%
  inner_join(
    teams %>% select(yearID, away = teamID, R_away = R, RA_away = RA, WPct_away = WPct),
    by = "yearID"
  ) %>%
  filter(teamID != away) %>%
  rename(home = teamID, R_home = R, RA_home = RA, WPct_home = WPct) %>%
  mutate(home_win = ifelse(WPct_home > WPct_away, 1, 0))


###############################################
# 4) Train/Test split (within 2000–2004)
###############################################

set.seed(2025)
idx <- sample(seq_len(nrow(final_df)), 0.8 * nrow(final_df))

train_df <- final_df[idx, ]
test_df  <- final_df[-idx, ]

###############################################
# 5) Train XGBoost model
###############################################

x_train <- as.matrix(train_df[, c("R_home","RA_home","R_away","RA_away")])
y_train <- train_df$home_win

x_test  <- as.matrix(test_df[,  c("R_home","RA_home","R_away","RA_away")])
y_test  <- test_df$home_win

dtrain <- xgb.DMatrix(x_train, label = y_train)
dtest  <- xgb.DMatrix(x_test,  label = y_test)

params <- list(
  objective = "binary:logistic",
  eval_metric = "logloss",
  eta = 0.05,
  max_depth = 4,
  subsample = 0.8,
  colsample_bytree = 0.8
)

xgb_model <- xgb.train(
  params = params,
  data = dtrain,
  nrounds = 300,
  watchlist = list(train = dtrain, test = dtest),
  verbose = 0
)

cat("Test AUC:", pROC::auc(y_test, predict(xgb_model, dtest)))


###############################################
# 6) Predict the 2005 World Series
###############################################

ws_2005  <- Teams %>% filter(yearID == 2005, teamID == "CHA")
hou_2005 <- Teams %>% filter(yearID == 2005, teamID == "HOU")

# Build prediction data frame
predict_df <- tibble(
  R_home  = ws_2005$R,
  RA_home = ws_2005$RA,
  R_away  = hou_2005$R,
  RA_away = hou_2005$RA
)

ws_neutral <- predict(xgb_model, as.matrix(predict_df))
ws_neutral


###############################################
# 7) Output interpretation
###############################################

cat("\n--- 2005 World Series Model Predictions (Neutral Model) ---\n")

# Game 1: White Sox home, Astros away
cat("Probability White Sox win at home (Game 1): ",
    round(ws_pred[1], 3), "\n")

# Game 2: Astros home, White Sox away 
#   → probability White Sox win on the road is (1 - home team's win probability)
cat("Probability White Sox win on road (Game 2): ",
    round(1 - ws_pred[2], 3), "\n")

# Neutral-field probability (average of home & road adjustments)
ws_neutral <- mean(c(ws_pred[1], 1 - ws_pred[2]))

cat("\nEstimated neutral-field win probability (team strength only): ",
    round(ws_neutral, 3), "\n")

# (0.839 + 0.686) / 2 = 0.7625
# probability WS win at home + probability WS win on road / 2  = 0.7625

```

```{r}
################################################
# Monte Carlo Simulation starts here
# This is the basic Monte Carlo with no pitching  

################################################


simulate_one_series_simple <- function(p_ws, best_of = 7) {
  ws_wins  <- 0
  hou_wins <- 0
  
  while (ws_wins < 4 && hou_wins < 4) {
    game_result <- rbinom(1, 1, p_ws)   # 1 = WS win, 0 = Astros win
    if (game_result == 1) {
      ws_wins <- ws_wins + 1
    } else {
      hou_wins <- hou_wins + 1
    }
  }
  
  list(
    winner = ifelse(ws_wins == 4, "WhiteSox", "Astros"),
    length = ws_wins + hou_wins
  )
}


simulate_series_mc_simple <- function(p_ws, trials = 20000) {
  winners <- character(trials)
  lengths <- integer(trials)
  
  for (i in seq_len(trials)) {
    s <- simulate_one_series_simple(p_ws)
    winners[i] <- s$winner
    lengths[i] <- s$length
  }
  
  df <- data.frame(
    winner = winners,
    length = lengths
  )
  
  list(
    ws_win_pct = mean(df$winner == "WhiteSox"),
    astros_win_pct = mean(df$winner == "Astros"),
    length_dist = prop.table(table(df$length)),
    raw = df
  )
}

```

```{r}
##############################
# Running simulation here
##############################

mc_simple <- simulate_series_mc_simple(ws_neutral, trials = 20000)

cat("White Sox win series probability:", 
    round(mc_simple$ws_win_pct * 100, 2), "%\n")

cat("Astros win series probability:", 
    round(mc_simple$astros_win_pct * 100, 2), "%\n\n")

cat("Series length distribution:\n")

length_dist <- mc_simple$length_dist

for (len in names(length_dist)) {
  cat(paste0(len, " games: ", round(as.numeric(length_dist[len]) * 100, 2), "%\n"))
}



```

```{r}
#########################################
# output on csv
#########################################

summary_df <- data.frame(
  white_sox_win_pct = mc_simple$ws_win_pct,
  astros_win_pct = mc_simple$astros_win_pct
)

# Convert length distribution into a dataframe
length_df <- data.frame(
  length = names(mc_simple$length_dist),
  proportion = as.numeric(mc_simple$length_dist)
)

# Export both
write.csv(summary_df, "mc_world_series_summary.csv", row.names = FALSE)
write.csv(length_df, "mc_world_series_length_distribution.csv", row.names = FALSE)

```
